name: Kubernetes Config Preview

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'k8s/backend/**'
      - 'k8s/frontend/**'

jobs:
  validate-kustomize:
    name: Validate Kubernetes Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build backend kustomization
        run: |
          echo "ğŸ” Building backend kustomization..."
          kubectl kustomize k8s/backend/ > /tmp/backend-preview.yaml
          echo "Generated manifest size: $(wc -l < /tmp/backend-preview.yaml) lines"
          echo "âœ… Backend kustomization is valid"

      - name: Build frontend kustomization
        run: |
          echo "ğŸ” Building frontend kustomization..."
          kubectl kustomize k8s/frontend/ > /tmp/frontend-preview.yaml
          echo "Generated manifest size: $(wc -l < /tmp/frontend-preview.yaml) lines"
          echo "âœ… Frontend kustomization is valid"

      - name: Validate Kubernetes manifests
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          
          # Dry-run validation using kubectl
          kubectl version --client
          kubectl apply --dry-run=client -f /tmp/backend-preview.yaml
          kubectl apply --dry-run=client -f /tmp/frontend-preview.yaml
          
          echo "âœ… All manifests are valid"

      - name: Comment PR with preview
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const backendManifest = fs.readFileSync('/tmp/backend-preview.yaml', 'utf8');
            const frontendManifest = fs.readFileSync('/tmp/frontend-preview.yaml', 'utf8');
            
            const comment = `## ğŸ¯ Kubernetes Configuration Preview
            
            ### âœ… Validation Results
            - **Backend kustomization**: âœ… Valid
            - **Frontend kustomization**: âœ… Valid
            - **Kubernetes dry-run**: âœ… Passed
            
            ### ğŸ“‹ Generated Manifests
            
            #### Backend
            - Lines: ${backendManifest.split('\n').length}
            - Components: API Server, 3x Consumer Workers
            - Namespace: backend
            
            #### Frontend
            - Lines: ${frontendManifest.split('\n').length}
            - Components: React App, Ingress
            - Namespace: frontend
            
            <details>
            <summary>ğŸ” View backend manifests preview (first 50 lines)</summary>
            
            \`\`\`yaml
            ${backendManifest.split('\n').slice(0, 50).join('\n')}
            ${backendManifest.split('\n').length > 50 ? '... (truncated)' : ''}
            \`\`\`
            </details>
            
            <details>
            <summary>ğŸ” View frontend manifests preview (first 50 lines)</summary>
            
            \`\`\`yaml
            ${frontendManifest.split('\n').slice(0, 50).join('\n')}
            ${frontendManifest.split('\n').length > 50 ? '... (truncated)' : ''}
            \`\`\`
            </details>
            
            ### ğŸš€ Deploy Commands
            
            \`\`\`bash
            # Deploy backend
            kubectl apply -k k8s/backend/
            
            # Deploy frontend
            kubectl apply -k k8s/frontend/
            
            # Deploy everything
            kubectl apply -k k8s/backend/ && kubectl apply -k k8s/frontend/
            \`\`\`
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
